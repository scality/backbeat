---
version: 0.2

branches:
  default:
    stage: pre-merge

stages:
  pre-merge:
    worker:
      type: kube_pod
      path: eve/workers/unit_and_feature_tests/pod.yml
      images:
        unit_and_feature_tests:
          context: .
          dockerfile: eve/workers/unit_and_feature_tests/Dockerfile
        kafka: eve/workers/kafka
    steps:
      - Git:
          name: fetch source
          repourl: '%(prop:git_reference)s'
          shallow: True
          retryFetch: True
          haltOnFailure: True
      - ShellCommand:
          name: run static analysis tools on markdown
          command: yarn run --silent lint_md
      - ShellCommand:
          name: run static analysis tools on code
          command: yarn run --silent lint
      - ShellCommand:
          name: run unit tests
          command: yarn test
      - ShellCommand:
          name: run bucket scanner unit tests
          command: ginkgo -r --randomizeAllSpecs --randomizeSuites --failOnPending --cover --trace --race --progress -nodes 4
          workdir: '%(prop:builddir)s/build/bucket-scanner'
      - ShellCommand:
          name: run backbeat routes test
          command: bash ./eve/workers/unit_and_feature_tests/run_server_tests.bash ft_test:api:routes
          workdir: '%(prop:builddir)s/build'
          env:
            CI: "true"
      - ShellCommand:
          name: run backbeat retry tests with account authentication
          command: bash ./eve/workers/unit_and_feature_tests/run_server_tests.bash ft_test:api:retry
          workdir: '%(prop:builddir)s/build'
          env:
            CI: "true"
            CI_AUTH_TYPE: "account"
            BACKBEAT_CONFIG_FILE: "tests/config.json"
      - ShellCommand:
          name: run backbeat retry tests with role authentication
          command: bash ./eve/workers/unit_and_feature_tests/run_server_tests.bash ft_test:api:retry
          workdir: '%(prop:builddir)s/build'
          env:
            CI: "true"
            CI_AUTH_TYPE: "role"
            BACKBEAT_CONFIG_FILE: "tests/config.roleAuth.json"
      - ShellCommand:
          name: run backbeat lib feature tests
          command: yarn run ft_test:lib
          env:
            CI: "true"
      - ShellCommand:
          name: run backbeat replication feature tests
          command: yarn run ft_test:replication
          env:
            CI: "true"
      - ShellCommand:
          name: run backbeat notification feature tests
          command: yarn run ft_test:notification
          env:
            CI: "true"


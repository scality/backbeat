evaluation_interval: 1m
rule_files:
  - alerts.rendered.yaml

tests:

  - name: LifecycleProducer Replicas
    interval: 1m
    input_series:
      - series: up{namespace="zenko",job="artesca-data-backbeat-lifecycle-producer-headless"}
        values: 1 0
    alert_rule_test:
      - alertname: LifecycleProducerDown
        eval_time: 1m
        exp_alerts: []
      - alertname: LifecycleProducerDown
        eval_time: 2m
        exp_alerts:
          - exp_labels:
              severity: critical
            exp_annotations:
              zenko_service: backbeat-lifecycle-producer
              description: "Lifecycle producer pod has been down for 30 seconds"
              summary: "Lifecycle producer service is down"

  - name: LifecycleBucketProcessor Replicas
    interval: 1m
    input_series:
      - series: up{namespace="zenko",job="artesca-data-backbeat-lifecycle-bucket-processor-headless",pod="bucket-1"}
        values: 1 1 1 
      - series: up{namespace="zenko",job="artesca-data-backbeat-lifecycle-bucket-processor-headless",pod="bucket-2"}
        values: 1 1 0
      - series: up{namespace="zenko",job="artesca-data-backbeat-lifecycle-bucket-processor-headless",pod="bucket-3"}
        values: 1 0 0
    alert_rule_test:
      - alertname: LifecycleBucketProcessorDegraded
        eval_time: 1m
        exp_alerts: []
      - alertname: LifecycleBucketProcessorCritical
        eval_time: 1m
        exp_alerts: []
      - alertname: LifecycleBucketProcessorDegraded
        eval_time: 2m
        exp_alerts:
          - exp_labels:
              severity: warning
            exp_annotations:
              zenko_service: backbeat-lifecycle-bucket-processor
              description: "Less than 100% of lifecycle bucket processors are up and healthy"
              summary: "Degraded lifecycle bucket processor"
      - alertname: LifecycleBucketProcessorCritical
        eval_time: 2m
        exp_alerts: []
      - alertname: LifecycleBucketProcessorDegraded
        eval_time: 3m
        exp_alerts:
          - exp_labels:
              severity: warning
            exp_annotations:
              zenko_service: backbeat-lifecycle-bucket-processor
              description: "Less than 100% of lifecycle bucket processors are up and healthy"
              summary: "Degraded lifecycle bucket processor"
      - alertname: LifecycleBucketProcessorCritical
        eval_time: 3m
        exp_alerts:
          - exp_labels:
              severity: critical
            exp_annotations:
              zenko_service: backbeat-lifecycle-bucket-processor
              description: "Less than 50% of lifecycle bucket processors are up and healthy"
              summary: "Degraded lifecycle bucket processor"

  - name: LifecycleObjectProcessor Replicas
    interval: 1m
    input_series:
      - series: up{namespace="zenko",job="artesca-data-backbeat-lifecycle-object-processor-headless",pod="object-1"}
        values: 1 1 1 
      - series: up{namespace="zenko",job="artesca-data-backbeat-lifecycle-object-processor-headless",pod="object-2"}
        values: 1 1 0
      - series: up{namespace="zenko",job="artesca-data-backbeat-lifecycle-object-processor-headless",pod="object-3"}
        values: 1 0 0
    alert_rule_test:
      - alertname: LifecycleObjectProcessorDegraded
        eval_time: 1m
        exp_alerts: []
      - alertname: LifecycleObjectProcessorCritical
        eval_time: 1m
        exp_alerts: []
      - alertname: LifecycleObjectProcessorDegraded
        eval_time: 2m
        exp_alerts:
          - exp_labels:
              severity: warning
            exp_annotations:
              zenko_service: backbeat-lifecycle-object-processor
              description: "Less than 100% of lifecycle object processors for expiration are up and healthy"
              summary: "Degraded lifecycle object processor"
      - alertname: LifecycleObjectProcessorCritical
        eval_time: 2m
        exp_alerts: []
      - alertname: LifecycleObjectProcessorDegraded
        eval_time: 3m
        exp_alerts:
          - exp_labels:
              severity: warning
            exp_annotations:
              zenko_service: backbeat-lifecycle-object-processor
              description: "Less than 100% of lifecycle object processors for expiration are up and healthy"
              summary: "Degraded lifecycle object processor"
      - alertname: LifecycleObjectProcessorCritical
        eval_time: 3m
        exp_alerts:
          - exp_labels:
              severity: critical
            exp_annotations:
              zenko_service: backbeat-lifecycle-object-processor
              description: "Less than 50% of lifecycle object processors for expiration are up and healthy"
              summary: "Degraded lifecycle object processor"

  - name: LifecycleBucketProcessorRequest
    interval: 1m
    input_series:
      - series: s3_lifecycle_s3_operations_total{namespace="zenko", job="artesca-data-backbeat-lifecycle-bucket-processor-headless", status="200", process="bucket"}
        values: 0+99x4 495+97x4 980+95x4 1455+98x4
      - series: s3_lifecycle_s3_operations_total{namespace="zenko", job="artesca-data-backbeat-lifecycle-bucket-processor-headless", status="413", process="bucket"}
        values: 0+1x4    5+3x4   20+5x4    45+2x4
      - series: s3_lifecycle_s3_operations_total{namespace="zenko", job="artesca-data-backbeat-lifecycle-object-processor-headless", status="200", process="expiration"}
        values: 0+100x19
    alert_rule_test:
      - alertname: LifecycleBucketProcessorRequest
        eval_time: 1m
        exp_alerts: []
      - alertname: LifecycleBucketProcessorRequest
        eval_time: 5m
        exp_alerts: []
      - alertname: LifecycleBucketProcessorRequest
        eval_time: 9m
        exp_alerts: []
      - alertname: LifecycleBucketProcessorRequest
        eval_time: 10m
        exp_alerts:
          - exp_labels:
              severity: warning
            exp_annotations:
              zenko_service: backbeat-lifecycle-bucket-processor
              description: "More than 3% of S3 requests by bucket processors resulting in errors"
              summary: "High rate of S3 request errors"
      - alertname: LifecycleBucketProcessorRequest
        eval_time: 14m
        exp_alerts:
          - exp_labels:
              severity: warning
            exp_annotations:
              zenko_service: backbeat-lifecycle-bucket-processor
              description: "More than 3% of S3 requests by bucket processors resulting in errors"
              summary: "High rate of S3 request errors"
      - alertname: LifecycleBucketProcessorRequest
        eval_time: 15m
        exp_alerts:
          - exp_labels:
              severity: warning
            exp_annotations:
              zenko_service: backbeat-lifecycle-bucket-processor
              description: "More than 3% of S3 requests by bucket processors resulting in errors"
              summary: "High rate of S3 request errors"
          - exp_labels:
              severity: critical
            exp_annotations:
              zenko_service: backbeat-lifecycle-bucket-processor
              description: "More than 5% of S3 requests by bucket processors resulting in errors"
              summary: "Very high rate of S3 request errors"
      - alertname: LifecycleBucketProcessorRequest
        eval_time: 19m
        exp_alerts: []

  - name: LifecycleObjectProcessorRequest
    interval: 1m
    input_series:
      - series: s3_lifecycle_s3_operations_total{namespace="zenko", job="artesca-data-backbeat-lifecycle-object-processor-headless", status="200", process="expiration"}
        values: 0+99x4 495+97x4 980+95x4 1455+98x4
      - series: s3_lifecycle_s3_operations_total{namespace="zenko", job="artesca-data-backbeat-lifecycle-object-processor-headless", status="413", process="expiration"}
        values: 0+1x4    5+3x4   20+5x4    45+2x4
      - series: s3_lifecycle_s3_operations_total{namespace="zenko", job="artesca-data-backbeat-lifecycle-bucket-processor-headless", status="200", process="bucket"}
        values: 0+100x19
    alert_rule_test:
      - alertname: LifecycleObjectProcessorRequest
        eval_time: 1m
        exp_alerts: []
      - alertname: LifecycleObjectProcessorRequest
        eval_time: 5m
        exp_alerts: []
      - alertname: LifecycleObjectProcessorRequest
        eval_time: 9m
        exp_alerts: []
      - alertname: LifecycleObjectProcessorRequest
        eval_time: 10m
        exp_alerts:
          - exp_labels:
              severity: warning
            exp_annotations:
              zenko_service: backbeat-lifecycle-object-processor
              description: "More than 3% of S3 requests by object processors resulting in errors"
              summary: "High rate of S3 request errors"
      - alertname: LifecycleObjectProcessorRequest
        eval_time: 14m
        exp_alerts:
          - exp_labels:
              severity: warning
            exp_annotations:
              zenko_service: backbeat-lifecycle-object-processor
              description: "More than 3% of S3 requests by object processors resulting in errors"
              summary: "High rate of S3 request errors"
      - alertname: LifecycleObjectProcessorRequest
        eval_time: 15m
        exp_alerts:
          - exp_labels:
              severity: warning
            exp_annotations:
              zenko_service: backbeat-lifecycle-object-processor
              description: "More than 3% of S3 requests by object processors resulting in errors"
              summary: "High rate of S3 request errors"
          - exp_labels:
              severity: critical
            exp_annotations:
              zenko_service: backbeat-lifecycle-object-processor
              description: "More than 5% of S3 requests by object processors resulting in errors"
              summary: "Very high rate of S3 request errors"
      - alertname: LifecycleObjectProcessorRequest
        eval_time: 19m
        exp_alerts: []
